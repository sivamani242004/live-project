<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Home - MR Technologies</title>
  <script src="https://cdn.tailwindcss.com"></script>     
  <style>
    :root {
      --primary-color: #113C71;
      --secondary-color: #f8f9fc;
      --accent-color: #03306e;
      --success-color: #16a34a;
      --danger-color: #dc2626;
      --text-color: #333333;
      --muted-text: #6b7280;
      --white: #ffffff;
      --font-base: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --transition-speed: 0.3s;
      --card-radius: 12px;
      --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: var(--font-base);
    }

    body {
      background-color: #f0f0f0;
    }

    .slide-link {
      position: relative;
      overflow: hidden;
      transition: background 0.3s ease;
    }
    .slide-link::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      transition: left var(--transition-speed) ease;
    }
    .slide-link:hover::before {
      left: 0;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .row-animate {
      animation: fadeSlideIn 0.4s ease-in-out;
    }
  </style>        
</head>
<body class="min-h-screen flex flex-col">

<!-- Top Bar -->
<header class="flex justify-between items-center bg-white shadow-md p-3 fixed top-0 left-0 right-0 z-50">
  <div class="flex items-center gap-4">
    <img src="/images/logo.jpg" alt="MR Technologies Logo" class="h-16 object-contain">
    <img src="/images/studentHome.png" alt="" style="width: 4rem;height: 4rem;">
    <h1 class="text-2xl font-bold text-[var(--primary-color)]">Student Home</h1>
  </div>
  <p class="text-sm text-gray-600">
    Welcome, <span class="font-semibold text-[var(--primary-color)]" id="username">Loading...</span>
  </p>
</header>

<!-- Page Layout -->
<div class="flex flex-1 pt-20">
  <!-- Sidebar -->
  <aside class="fixed top-[80px] left-0 w-72 bg-[var(--primary-color)] text-white" style="height: calc(100% - 80px); padding-top: 10px; z-index: 30; font-size: 20px;">
    <nav class="flex flex-col gap-4" style="margin-top: 10%; margin-left: 10%;">
      <a href="/dashboard" class="p-3 rounded slide-link">Dashboard</a>
      <a href="/courses" class="p-3 rounded slide-link">Courses</a>
      <a href="/studenthome" class="p-3 rounded slide-link">Students</a>
      <a href="/Batch" class="p-3 rounded slide-link">Batch</a>
      <a href="/payments" class="p-3 rounded slide-link">Finance</a>
      <a href="/reports" class="p-3 rounded slide-link">Reports</a>
    </nav>
    <button onclick="logout()" class="mt-4 text-left text-red-300 hover:text-white p-3 transition" style="margin-left: 10%;">Logout</button>
  </aside>

<!-- Main Content -->
<div class="max-w-6xl mx-auto p-8 bg-white shadow-xl rounded-2xl" style="margin-left:17rem; width: 100%;">
  <!-- Header Buttons -->
  <div class="flex justify-between items-center mb-8">
    <button onclick="openRegistration()" 
            class="bg-gradient-to-r from-indigo-500 to-indigo-700 text-white px-5 py-3 rounded-xl shadow-lg hover:from-indigo-600 hover:to-indigo-800 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl">
      â• Register New Student
    </button>
    <a href="/studentlist" 
       class="bg-gradient-to-r from-green-500 to-green-700 text-white px-5 py-3 rounded-xl shadow-lg hover:from-green-600 hover:to-green-800 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl">
      ğŸ“‹ View Student List
    </a>
  </div>

  <!-- Search Input -->
  <div class="mb-8 flex justify-center">
    <input id="searchInput" 
           type="text" 
           placeholder="ğŸ” Search by Name or Mobile" 
           class="w-3/4 border border-gray-300 p-4 rounded-xl shadow-sm focus:outline-none focus:ring-4 focus:ring-indigo-300 text-lg transition-all duration-300 hover:shadow-md" />
  </div>

  <!-- Student Results -->
  <div id="studentResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Static Example Card -->
    
  </div>
</div>
<div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-2xl shadow-lg relative">
    <button onclick="closePreview()" 
            class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    <h2 class="text-2xl font-bold text-indigo-700 mb-6 border-b pb-2">Student Preview</h2>
    <div id="previewContent" class="space-y-2 text-gray-700 text-base leading-relaxed">
      <!-- Filled dynamically -->
    </div>
    <div class="mt-5 flex justify-end">
      <button onclick="closePreview()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 transition">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Scripts -->

<script>
let allStudents = [];

function openRegistration() {
  window.location.href = "/student";
}

function editStudent(studentId) {
  window.location.href = "/student/edit/" + studentId;
}

function deleteStudent(studentId) {
  if (confirm("Are you sure you want to delete this student?")) {
    fetch(`/api/students/${studentId}`, { method: "DELETE" })
      .then(response => {
        if (!response.ok) throw new Error("Failed to delete student.");
        alert("âœ… Student deleted successfully!");
        loadStudents();
      })
      .catch(error => alert("âŒ Error: " + error.message));
  }
}

function previewStudent(studentId) {
	  fetch(`/api/students/${studentId}`)
	    .then(res => {
	      if (!res.ok) throw new Error("Failed to fetch student details");
	      return res.json();
	    })
	    .then(student => {
	      const previewHTML = `
	        <div class="bg-gradient-to-br from-indigo-50 to-white rounded-lg shadow p-6 border border-gray-200">
	          <div class="flex items-center mb-6">
	            <div class="flex-shrink-0 w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-700 text-3xl font-bold">
	              ${student.name.charAt(0).toUpperCase()}
	            </div>
	            <div class="ml-4">
	              <h3 class="text-xl font-bold text-indigo-700">${student.name}</h3>
	              <p class="text-gray-600">${student.course} - Batch ${student.batch}</p>
	            </div>
	          </div>

	          <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 text-gray-700">
	            <div><span class="font-semibold text-gray-900">ğŸ“§ Email:</span> ${student.email}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ“ Mobile:</span> ${student.mobile}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ‚ DOB:</span> ${student.dob}</div>
	            <div><span class="font-semibold text-gray-900">ğŸš» Gender:</span> ${student.gender}</div>
	            <div class="sm:col-span-2"><span class="font-semibold text-gray-900">ğŸ  Address:</span> ${student.address}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ“ Qualification:</span> ${student.qualification}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ“… Joining Date:</span> ${student.joiningDate}</div>
	            <div><span class="font-semibold text-gray-900">â³ Duration:</span> ${student.duration}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ’° Course Fee:</span> â‚¹${student.coursefee}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ· Discount:</span> ${student.discount}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ’µ Total Fee:</span> â‚¹${student.totalfee}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ“„ Term-1:</span> ${student.term_1}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ’³ Paid Amount:</span> â‚¹${student.paidamount}</div>
	            <div><span class="font-semibold text-gray-900">ğŸ“‰ Due Fee:</span> â‚¹${student.duefee}</div>
	            <div class="sm:col-span-2">
	              <span class="font-semibold text-gray-900">ğŸ“Œ Status:</span> 
	              <span class="${student.status?.toLowerCase() === 'active' ? 'bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-semibold' : 'bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-semibold'}">
	                ${student.status}
	              </span>
	            </div>
	          </div>
	        </div>
	      `;

	      document.getElementById("previewContent").innerHTML = previewHTML;
	      document.getElementById("previewModal").classList.remove("hidden");
	    })
	    .catch(err => {
	      alert("âŒ Error: " + err.message);
	    });
	}


function closePreview() {
  document.getElementById("previewModal").classList.add("hidden");
}

function renderStudents(students) {
  const container = document.getElementById("studentResults");
  if (students.length === 0) {
    container.innerHTML = `<div class="text-gray-500">No students found.</div>`;
    return;
  }

  container.innerHTML = students.map(student => `
    <div class="bg-white border border-gray-200 rounded-2xl shadow-md p-5 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 row-animate">
      <div class="flex justify-between items-start">
        <div>
          <h3 class="text-lg font-semibold text-indigo-700">${student.name}</h3>
          <p class="text-gray-600 text-sm">ğŸ“ ${student.mobile}</p>
          <p class="text-gray-600 text-sm">ğŸ“§ ${student.email}</p>
          <p class="text-gray-600 text-sm">ğŸ“ ${student.course}</p>
        </div>
        <div class="flex flex-col gap-2">
          <button onclick="previewStudent(${student.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 text-sm rounded shadow-md">
            ğŸ‘ Preview
          </button>
          <button onclick="editStudent(${student.id})" class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 text-sm rounded shadow-md">
            âœ Edit
          </button>
          <button onclick="deleteStudent(${student.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 text-sm rounded shadow-md">
            ğŸ—‘ Delete
          </button>
        </div>
      </div>
    </div>
  `).join("");
}

function loadStudents() {
  fetch("/api/students/getstudents")
    .then(res => {
      if (!res.ok) throw new Error("Failed to fetch");
      return res.json();
    })
    .then(data => {
      allStudents = data;

      // Sort by date (most recent first)
      allStudents.sort((a, b) => new Date(b.registrationDate) - new Date(a.registrationDate));

      // Show only the latest 12 initially
      const latestStudents = allStudents.slice(0, 12);
      renderStudents(latestStudents);
    })
    .catch(err => {
      document.getElementById("studentResults").innerHTML =
        `<div class='text-red-500'>Error fetching student data: ${err.message}</div>`;
    });
}

document.getElementById("searchInput").addEventListener("input", function () {
  const keyword = this.value.trim().toLowerCase();
  const filtered = allStudents
    .filter(student =>
      student.name.toLowerCase().includes(keyword) ||
      student.mobile.toString().toLowerCase().includes(keyword)
    );

  if (keyword === "") {
    const latestStudents = allStudents.slice(0, 12);
    renderStudents(latestStudents);
  } else {
    renderStudents(filtered);
  }
});

fetch("/api/username", { credentials: 'include' })
  .then(response => {
    if (!response.ok) throw new Error("Not logged in");
    return response.text();
  })
  .then(username => document.getElementById("username").innerText = username)
  .catch(() => document.getElementById("username").innerText = "Guest");

window.onload = loadStudents;
</script>


</body>
</html>
