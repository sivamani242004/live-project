<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MR Technologies - Payments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
      --primary-color: #113C71;
      --secondary-color: #f8f9fc;
      --accent-color: #03306e;
      --success-color: #16a34a;
      --danger-color: #dc2626;
      --text-color: #333333;
      --muted-text: #6b7280;
      --white: #ffffff;
      --font-base: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --transition-speed: 0.3s;
      --card-radius: 12px;
      --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: var(--font-base);
    }

    body {
      background-color: #f0f0f0;
    }

    .slide-link {
      position: relative;
      overflow: hidden;
      transition: background 0.3s ease;
    }

    .slide-link::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      transition: left var(--transition-speed) ease;
    }

      body {
        font-family: sans-serif;
      }

      .nav {
        display: flex;
        padding: 10px 0;
      }

      .tab {
        padding: 10px 20px;
        background: #a7aacc;
        color: #333;
        width: 200px;
        margin-left: 5px;
        font-size: 20px;
        cursor: pointer;
      }

      .tab.active {
        background: #2f41e6;
        color: white;
      }

      .tab:hover {
        background: #d0d0d8;
      }

      .tab-content {
        display: none;
        padding: 20px;
      }

      .tab-content.active {
        display: block;
      }

      .main {
        margin-left: 220px;
        margin-top: 80px;
        padding: 20px;
      }

      .main-content {
        background: #343fe0;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .wrapper {
        background: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        width: 95%;
        max-width: 1100px;
        margin: 0 auto;
        overflow-x: auto;
      }

      h1 {
        text-transform: uppercase;
        margin-bottom: 20px;
        color: #0e11ac;
        font-size: 20px;
        font-weight: bold;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
      }

      thead {
        background: #1c4ac7;
        color: white;
        text-transform: uppercase;
      }

      th,
      td {
        padding: 12px;
        text-align: center;
        font-size: 14px;
        border: 1px solid #ddd;
      }

      tbody tr:hover {
        background: #8693be;
        transition: background 0.3s ease-in-out;
      }

      /* Batch Payments Section */
      .daily-payments {
        background: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        width: 90%;
        margin: 0 auto;
      }

      .daily-payments h2 {
        text-align: center;
        font-size: 24px;
        color: #000;
        margin-bottom: 20px;
      }

      .batch-selection {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .batch-selection label {
        font-weight: bold;
        color: #554dc9;
      }

      .batch-selection select,
      .batch-selection button {
        padding: 10px 15px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 16px;
      }

      .batch-selection button {
        background-color: #110eaf;
        color: white;
        cursor: pointer;
      }

      .batch-selection button:hover {
        background-color: #1618a0;
      }

      .scroll-table {
        max-height: 400px;
        overflow-x: auto;
        overflow-y: auto;
        margin-top: 20px;
        border: 1px solid #ccc;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 500px;
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: relative;
      }

      .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 22px;
        font-weight: bold;
        color: red;
        cursor: pointer;
      }

      .close:hover {
        color: darkred;
      }
    </style>
  </head>
<body class="min-h-screen flex flex-col">

<!-- Top Bar -->
<header class="flex justify-between items-center bg-white shadow-md p-3 fixed top-0 left-0 right-0 z-50">
  <div class="flex items-center gap-4">
    <img src="/images/logo.jpg" alt="MR Technologies Logo" class="h-16 object-contain">
    <img src="/images/payments.png" alt="" style="width: 4rem;height: 4rem;">
    <h1 class="text-2xl font-bold text-[var(--primary-color)]">Finance</h1>

  </div>
  <p class="text-sm text-gray-600">
    Welcome, <span class="font-semibold text-[var(--primary-color)]" id="username">Loading...</span>
  </p>
</header>

<!-- Page Layout -->
<div class="flex flex-1 pt-20">
  <!-- Sidebar -->
 <aside class="fixed top-[80px] left-0 w-72 bg-[var(--primary-color)] text-white " style="height: calc(100% - 80px); padding-top: 10px; z-index: 30; font-size: 20px;">
    <nav class="flex flex-col gap-4" style="margin-top: 10%;margin-left: 10%;">
      <a href="/dashboard" class="p-3 rounded slide-link">Dashboard</a>
      <a href="/courses" class="p-3 rounded slide-link">Courses</a>
      <a href="/studenthome" class="p-3 rounded slide-link">Students</a>
      <a href="/Batch" class="p-3 rounded slide-link">Batch</a>
      <a href="/payments" class="p-3 rounded slide-link">Finance</a>
      <a href="/reports" class="p-3 rounded slide-link">Reports</a>
    </nav>
    <button onclick="logout()" class="mt-4 text-left text-red-300 hover:text-white p-3 transition" style="margin-left: 10%;">Logout</button>
  </aside> 

      <div class="main" style="margin-left: 17rem;">
        <!-- Tabs -->
        <div class="nav">
          <div class="tab active" onclick="showTab('dashboard')">
            Daily Payments
          </div>
          <div class="tab" onclick="showTab('account')">Batch Payments</div>
        </div>

       


        <section
          id="dashboard"
          class="tab-content active px-4 md:px-8 lg:px-10 py-6"
        >
        
         <div class="bg-white shadow-lg rounded-2xl p-6 mt-6 w-full max-w-5xl mx-auto">
          <!-- Search Bar -->
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-purple-700">Student Records</h2>
            <input type="text" id="searchInput" placeholder="Search by name or ID" 
              class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 w-64">
          </div>

          <!-- Scrollable Table -->
          <div class="overflow-y-auto max-h-64 border border-gray-200 rounded-lg">
            <table class="w-full text-left border-collapse">
              <thead class="bg-purple-600 text-white sticky top-0">
                 <div id="studentResults" class="space-y-4">
                   <!-- Matching student cards will appear here -->
                  </div>
                <!-- Add more rows for testing scroll -->
              </tbody>
            </table>
            </div>
        </div>
          <div
            class="bg-white rounded-2xl shadow-xl p-6 md:p-8 max-w-7xl mx-auto"
          >
            <h1 class="text-3xl font-semibold text-center mb-8 text-indigo-700">
              Daily Payments
            </h1>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              
				<div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Student id</label
                >
                <input
                  id="studentId"
                  type="number"
                  readonly
                  placeholder="Student id"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>
              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Student Name</label
                >
                <input
                  id="studentName"
                  type="text"
                  readonly
                  placeholder="Student Name"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>
              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Phone number</label
                >
                <input
                  id="phoneNumber"
                  type="text"
                  readonly
                  placeholder="Mobile number"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>

              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Course Type</label
                >
                <input
                  id="courseType"
                  type="text"
                  readonly
                  placeholder="Course Type"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>
              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Batch Code</label
                >
                <input
                  id="batchCode"
                  type="text"
                  readonly
                  placeholder="Batch Code"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>
               <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Batch Status</label
                >
                <input
                  id="statusDisplay"
                  type="text"
                  readonly
                  placeholder="Batch Status"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>
               <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Total fee</label
                >
                <input
                  id="totalfee"
                  type="text"
                  readonly
                  placeholder="totalfee"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>

              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Total Amount Paid</label
                >
                <input
                  id="totalAmountPaid"
                  type="text"
                  readonly
                  placeholder="Amount Paid"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>

              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Total Due Amount</label
                >
                <input
                  id="totalDue"
                  type="number"
                  readonly
                  placeholder="₹ 0.00"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>

             

              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Payment Date</label
                >
                <input
                  type="date"
                  class="w-full border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>

              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Term Fees</label
                >
                <select
                  id="termSelect"
                  onchange="checkOtherTerm()"
                  class="w-full border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                >
                  <option value="">Select Term</option>
                  <option value="Term-2">Term-2</option>
                  <option value="Term-3">Term-3</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <!-- Optional Custom Term -->
              <div id="customTermContainer" style="display: none">
                <label class="block text-purple-700 font-semibold mb-1"
                  >Enter Custom Term</label
                >
                <input
                  id="customTerm"
                  type="text"
                  placeholder="e.g., Term-4"
                  class="w-full border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>

              
              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Amount to be Paid</label
                >
                <input
                  id="amountToBePaid"
                  type="number"
                  placeholder="₹ 0.00"
                  class="w-full border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>

              <div>
                <label class="block text-purple-700 font-semibold mb-1"
                  >Remaining Due</label
                >
                <input
                  id="duefee"
                  type="number"
                  readonly
                  placeholder="₹ 0.00"
                  class="w-full border rounded px-4 py-2 bg-gray-100 focus:outline-none"
                />
              </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center mt-8">
              <button
                id="submitPaymentBtn"
                class="bg-indigo-800 text-white px-8 py-3 rounded-xl hover:bg-indigo-900 transition"
              >
                Submit Payment
              </button>
            </div>
          </div>

          <!-- date range -->
          <div class="flex flex-wrap gap-4 justify-center mt-6">
            <div>
              <label class="block text-purple-700 font-semibold mb-1"
                >From Date</label
              >
              <input
               type="date" id="fromDate" 
                class="border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>

            <div>
              <label class="block text-purple-700 font-semibold mb-1"
                >To Date</label
              >
              <input
                type="date" id="toDate"
                class="border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>

            <div class="flex items-end">
               <button onclick="filterPayments()" class="bg-blue-600 text-white px-4 py-1 rounded">
    Filter
  </button>
            </div>
          </div>

          <!-- Daily Transactions Table -->
          <main class="main-content mt-10">
            <div class="wrapper">
              <h1>Daily Transactions</h1>
              <!-- Pagination Controls -->
<div class="flex justify-center items-center gap-2 mb-4 text-sm" id="paginationControls">
  <button onclick="firstPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">«</button>
  <button onclick="prevPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&lt;</button>
  <input type="number" id="currentPage" value="1" class="w-12 text-center border border-gray-300 rounded" min="1" />
  <span id="totalPages" class="text-gray-600">of 1</span>
  <button onclick="nextPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&gt;</button>
  <button onclick="lastPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">»</button>
</div>


              
              <div class="overflow-auto">
                <table id="table1">
                  <thead>
                    <tr>
                      <th>STUDENT ID</th>
                      <th>BATCH ID</th>
                      <th>BATCH STATUS</th>
                      <th>COURSE</th>
                      <th>FULL NAME</th>
                      <th>PHONE</th>
                      <th>AMOUNT PAID</th>
                      <th>TERM</th>
                      <th>DATE (PAID)</th>
                    </tr>
                  </thead>
                  <tbody id="transactionTable" style="font-size: 12px"></tbody>
                </table>
              </div>
            </div>
          </main>
        </section>

        <!-- Batch Payments -->
        <section id="account" class="tab-content">
          <main class="main-content-1">
            <div class="daily-payments">
              <h2>Batch Payments</h2>
              <div class="batch-selection">
                <div class="form-group">
                  <label for="CourseType">Course Type:</label>
                  <select id="CourseType" onchange="loadStatuses()">
                    <option value="">Loading...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="BatchStatus">Status:</label>
                  <select id="BatchStatus" onchange="loadBatchCodes()">
                    <option value="">Select Status</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="BatchCode">Batch Code:</label>
                  <select id="BatchCode">
                    <option value="">Select Batch</option>
                  </select>
                </div>
                <div class="form-group">
                  <button onclick="getDetails()">Get Details</button>
                </div>
              </div>
            </div>

            <!-- Scrollable Table -->
            <div class="scroll-table">
            <!-- Batch Table Pagination Controls -->
<div class="flex justify-center items-center gap-2 mb-4 text-sm" id="batchPaginationControls">
  <button onclick="goToBatchPage(1)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">«</button>
  <button onclick="prevBatchPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&lt;</button>
  <input type="text" id="currentBatchPage" value="1" class="w-10 text-center border border-gray-300 rounded" readonly />
  <span id="totalBatchPages" class="text-gray-600">of 1</span>
  <button onclick="nextBatchPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&gt;</button>
  <button onclick="goToBatchPage(totalBatchPages)" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">»</button>
</div>
            
              <table>
                <thead>
                  <tr>
                    <th>Student ID</th>
                    <th>Batch Code</th>
                    <th>Course</th>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Total Amount</th>
                    <th>Fee(Paid)</th>
                    <th>Total Due</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="BatchTableBody" style="font-size: 12px"></tbody>
              </table>
            </div>
          </main>

          <!-- Modal -->
          <div id="termsModal" class="modal">
            <div class="modal-content">
              <span class="close" onclick="closeModal()">&times;</span>
              <h2>Transaction Details</h2>
              <table>
                <thead>
                  <tr>
                    <th>Term</th>
                    <th>Name</th>
                    <th>Amount Paid</th>
                    <th>Paid Date</th>
                  </tr>
                </thead>
        <tbody id="BatchTransactionTable">
               
             </tbody> 
              </table>
            </div>
          </div>
        </section>
      </div>
    </div>

     <script>
      function logout() {
        window.location.href = "/login";
      }
      fetch("http://localhost:8080/api/username", {
        credentials: "include",
      })
        .then((response) => {
          if (!response.ok) throw new Error("Not logged in");
          return response.text();
        })
        .then((username) => {
          document.getElementById("username").innerText = username;
        })
        .catch(() => {
          document.getElementById("username").innerText = "Guest";
        });
      function showTab(tabId) {
        document
          .querySelectorAll(".tab")
          .forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));
        event.currentTarget.classList.add("active");
        document.getElementById(tabId).classList.add("active");
      }

      function closeModal() {
        document.getElementById("termsModal").style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", function () {
        fetchDailyPayments();
        fetchCourseTypes();

      });

//search
document.getElementById("searchInput").addEventListener("input", function () {
  const keyword = this.value.trim();
  if (keyword.length < 2) {
    document.getElementById("studentResults").innerHTML = "";
    return;
  }

  fetch("http://localhost:8080/api/students/search?keyword=" + keyword)
    .then((res) => res.json())
    .then((data) => {
      let html = "";
      if (data.length === 0) {
        html = `<div class="text-gray-500">No students found.</div>`;
      } else {
        html = data
          .map(
            (student, index) => `
          <div class="bg-white p-4 rounded shadow-md relative border border-gray-200">
            <h3 class="text-lg font-semibold text-indigo-700">${student.name}</h3>
            <p><strong>Mobile:</strong> ${student.mobile}</p>
            <p><strong>Email:</strong> ${student.email}</p>
            <p><strong>Course:</strong> ${student.course}</p>
            <div class="absolute top-4 right-4 flex gap-2">
              <button class="selectStudentBtn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 text-sm rounded"
                data-index="${index}">
                Select
              </button>
            </div>
          </div>
        `
          )
          .join("");
      }
      document.getElementById("studentResults").innerHTML = html;

      // ✅ Attach onclick to each Select button
      const buttons = document.querySelectorAll(".selectStudentBtn");
      buttons.forEach((button) => {
        button.addEventListener("click", function () {
          const index = this.getAttribute("data-index");
          const student = data[index];

          // ✅ Show popup message
          alert(`${student.name} is selected`);

          // ✅ Populate form fields
          document.getElementById("studentId").value = student.id;
          document.getElementById("studentName").value = student.name;
          document.getElementById("courseType").value = student.course;
          document.getElementById("phoneNumber").value = student.mobile;
          document.getElementById("totalfee").value = student.totalfee;
          document.getElementById("totalAmountPaid").value = student.paidamount;
          document.getElementById("batchCode").value = student.batch;
          document.getElementById("totalDue").value = student.duefee;

          fetchBatchStatus(); // Ensure this function is defined elsewhere
        });
      });
    })
    .catch((err) => {
      document.getElementById("studentResults").innerHTML =
        "<div class='text-red-500'>Error fetching student data.</div>";
    });
});
      // total due = total due - amount to be paid
      document
        .getElementById("amountToBePaid")
        .addEventListener("input", calculateDueAmount);

      function calculateDueAmount() {
        // Get numeric values only
        const totalStr = document
          .getElementById("totalDue")
          .value.replace(/[^\d.]/g, "");
        const paidStr = document
          .getElementById("amountToBePaid")
          .value.replace(/[^\d.]/g, "");
        const total = parseFloat(totalStr) || 0;
        const paid = parseFloat(paidStr) || 0;
        const due = total - paid;
        // Show due in separate readonly field (do not overwrite original due)
        document.getElementById("duefee").value =
          due >= 0 ? due.toFixed(2) : "0.00";
      }
      function checkOtherTerm() {
        const term = document.getElementById("termSelect").value;
        const customTermContainer = document.getElementById(
          "customTermContainer"
        );
        if (term === "Other") {
          customTermContainer.style.display = "block";
        } else {
          customTermContainer.style.display = "none";
          document.getElementById("customTerm").value = ""; // clear the field
        }
      }
      function fetchBatchStatus() {
        const batchCode = document.getElementById("batchCode").value.trim();
        const statusInput = document.getElementById("statusDisplay");

        if (!batchCode) {
          statusInput.value = "";
          return;
        }
        fetch(`http://localhost:8080/api/batch/status/${batchCode}`)
          .then((response) => {
            if (!response.ok) throw new Error("Batch not found");
            return response.text();
          })
          .then((status) => {
            statusInput.value = status;
          })
          .catch((error) => {
            statusInput.value = "Not Found";
            console.error("Error fetching batch status:", error);
          });
      }   
      //submit button 
     document.getElementById("submitPaymentBtn").addEventListener("click", function () {
  // Gather all required fields
  const studentId = document.getElementById("studentId").value;
  const studentName = document.getElementById("studentName").value;
  const phoneNumber = document.getElementById("phoneNumber").value;
  const courseType = document.getElementById("courseType").value;
  const batchCode = document.getElementById("batchCode").value;
  const totalfee = parseFloat(document.getElementById("totalfee").value) || 0;
  const statusDisplay = document.getElementById("statusDisplay").value;
  const paymentDate = document.querySelector('input[type="date"]').value;
  const amountToBePaid = parseFloat(document.getElementById("amountToBePaid").value) || 0;
  let totalAmountPaid = parseFloat(document.getElementById("totalAmountPaid").value) || 0;
  let totalDue = parseFloat(document.getElementById("totalDue").value) || 0;
  // ✅ Update totals
  totalAmountPaid += amountToBePaid;
  totalDue = totalfee - totalAmountPaid;  // recalc due from total fee - paid
  // Update UI fields immediately
  document.getElementById("totalAmountPaid").value = totalAmountPaid.toFixed(2);
  document.getElementById("totalDue").value = totalDue.toFixed(2);
  document.getElementById("duefee").value = totalDue.toFixed(2);
  const term = document.getElementById("termSelect").value;
  const customTerm = document.getElementById("customTerm").value;
  const finalTerm = term === "Other" ? customTerm : term;

  if (!studentName || !amountToBePaid || !paymentDate || !finalTerm) {
    alert("Please fill all required fields");
    return;
  }
  const paymentData = {
    studentId,
    studentName,
    phoneNumber,
    courseType,
    batchCode,
    totalfee,
    statusDisplay,
    paymentDate,
    amountPaid: amountToBePaid,
    totalAmountPaid,  // ✅ new total
    totalDue,         // ✅ new due
    term: finalTerm
  };
  // ✅ Save payment
  fetch("http://localhost:8080/api/payments", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(paymentData),
  })
    .then((response) => {
      if (!response.ok) throw new Error("Failed to save payment");
      return response.json();
    })
    .then((result) => {
      alert("Payment saved successfully!");
      location.reload();
    })
    .catch((error) => {
      console.error("Payment error:", error);
      alert("Failed to save payment. Try again.");
    });
});

  //filter data with date  and fetch daily payments
   let allPayments = [];   // Holds all payments (filtered or unfiltered)
  let currentPage = 1;
  const rowsPerPage = 4; // Rows per page 

  // Load all payments initially
  async function loadAllPayments() {
    try {
      const response = await fetch("http://localhost:8080/api/payments");
      allPayments = await response.json() || [];

      // ✅ Reset to first page
      currentPage = 1;
      renderTable();
    } catch (error) {
      console.error("Error fetching payments:", error);
    }
  }

  // Filter payments by date (server-side)
  async function filterPayments() {
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;

    if (!fromDate || !toDate) {
      alert("Please select both From and To dates");
      return;
    }

    try {
      const response = await fetch(
        `http://localhost:8080/api/payments/filter?fromDate=${fromDate}&toDate=${toDate}`
      );
      allPayments = await response.json() || [];

      // ✅ Reset to first page
      currentPage = 1;
      renderTable();
    } catch (error) {
      console.error("Error filtering payments:", error);
    }
  }

  // Render table with pagination
  function renderTable() {
    const tbody = document.getElementById("transactionTable");

    // ✅ Always clear table completely
    tbody.innerHTML = "";

    // ✅ Calculate total pages correctly
    const totalPages = Math.max(Math.ceil(allPayments.length / rowsPerPage), 1);
    document.getElementById("totalPages").innerText = "of " + totalPages;
    document.getElementById("currentPage").value = currentPage;

    // ✅ Slice only rowsPerPage data
    const start = (currentPage - 1) * rowsPerPage;
    const end = Math.min(start + rowsPerPage, allPayments.length);
    const pageData = allPayments.slice(start, end);

    if (pageData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500">No records found</td></tr>`;
      return;
    }

    // ✅ Render only paginated data
    pageData.forEach((payment) => {
      const row = `
        <tr>
          <td>${payment.studentId}</td>
          <td>${payment.batchCode}</td>
          <td>${payment.statusDisplay || ""}</td>
          <td>${payment.courseType}</td>
          <td>${payment.studentName}</td>
          <td>${payment.phoneNumber}</td>
          <td>${payment.amountPaid}</td>
          <td>${payment.term}</td>
          <td>${payment.paymentDate}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  }

  // Pagination functions
  function nextPage() {
    const totalPages = Math.ceil(allPayments.length / rowsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderTable();
    }
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      renderTable();
    }
  }

  function goToPage(page) {
    const totalPages = Math.ceil(allPayments.length / rowsPerPage);
    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      renderTable();
    } else {
      document.getElementById("currentPage").value = currentPage;
    }
  }

  function firstPage() {
    currentPage = 1;
    renderTable();
  }

  function lastPage() {
    const totalPages = Math.ceil(allPayments.length / rowsPerPage);
    currentPage = totalPages;
    renderTable();
  }

  // Setup event listener for page input
  document.addEventListener("DOMContentLoaded", () => {
    const pageInput = document.getElementById("currentPage");
    pageInput.addEventListener("change", () => {
      const page = parseInt(pageInput.value);
      goToPage(page);
    });

    // ✅ Load data when DOM is ready
    loadAllPayments();
  });

//batch payments 
function getDetails() {
    	  const course = document.getElementById("CourseType").value.trim();
    	  const status = document.getElementById("BatchStatus").value.trim();
    	  const batch = document.getElementById("BatchCode").value.trim();

    	  if (!course || !status || !batch) {
    	    alert("Please select Course Type, Status, and Batch Code.");
    	    return;
    	  }
    	  fetch(`http://localhost:8080/api/students/filter?course=${course}&status=${status}&batch=${batch}`)
    	    .then((response) => {
    	      if (!response.ok) throw new Error("Failed to fetch batch students");
    	      return response.json();
    	    })
    	    .then((students) => {
    	      allBatchStudents = students;
    	      totalBatchPages = Math.ceil(allBatchStudents.length / batchRowsPerPage);
    	      document.getElementById("totalBatchPages").innerText = `of ${totalBatchPages}`;
    	      renderBatchTablePage(1);
    	    })
    	    .catch((error) => {
    	      console.error("Error loading batch students:", error);
    	    });
    	}
      //renderfor BatchTablePage
       function renderBatchTablePage(page) {
    	  const tableBody = document.getElementById("BatchTableBody");
    	  tableBody.innerHTML = "";

    	  const start = (page - 1) * batchRowsPerPage;
    	  const end = start + batchRowsPerPage;
    	  const pageData = allBatchStudents.slice(start, end);

    	  if (pageData.length === 0) {
    	    tableBody.innerHTML = `<tr><td colspan="9">No students found for selected batch.</td></tr>`;
    	    return;
    	  }
    	  pageData.forEach((student) => {
    	    const totalfee = parseInt(student.totalfee || 0);
    	    const paid = parseInt(student.paidamount || 0);
    	    const due = parseInt(student.duefee || totalfee - paid);

    	    const row = document.createElement("tr");
    	    row.innerHTML = `
    	      <td>${student.id || ""}</td>
    	      <td>${student.batch || ""}</td>
    	      <td>${student.course || ""}</td>
    	      <td>${student.name || ""}</td>
    	      <td>${student.mobile || ""}</td>
    	      <td>₹ ${totalfee}</td>
    	      <td>₹ ${paid}</td>
    	      <td>₹ ${due}</td>
    	      <td><button onclick="showTerms('${student.mobile}')" class="text-blue-600 underline hover:text-blue-800">View</button></td>
    	    `;
    	    tableBody.appendChild(row);
    	  });

    	  currentBatchPage = page;
    	  document.getElementById("currentBatchPage").value = page;
    	}
      //Add Navigation Functions for batches
      function goToBatchPage(page) {
    	  if (page < 1 || page > totalBatchPages) return;
    	  renderBatchTablePage(page);
    	}
    	function nextBatchPage() {
    	  if (currentBatchPage < totalBatchPages) {
    	    renderBatchTablePage(currentBatchPage + 1);
    	  }
    	}
    	function prevBatchPage() {
    	  if (currentBatchPage > 1) {
    	    renderBatchTablePage(currentBatchPage - 1);
    	  }
    	}
    	function showTerms(phoneNumber) {
    		  // Step 1: Get student details based on phone number
    		  const student = allBatchStudents.find(s => s.mobile === phoneNumber);
    		  if (!student) {
    		    alert("Student not found in batch list.");
    		    return;
    		  }
    		  // Step 2: Fetch all payments by phone number
    		  fetch(`http://localhost:8080/api/payments`)
    		    .then((response) => response.json())
    		    .then((data) => {
    		      const filtered = data.filter((p) => p.phoneNumber === phoneNumber);
    		      const tbody = document.getElementById("BatchTransactionTable");
    		      tbody.innerHTML = "";
    		      // Step 3: Add First Term row (from student table)
    		      const term1Row = document.createElement("tr");
    		      term1Row.innerHTML = `
    		        <td>Term-1</td>
    		        <td>${student.name || "-"}</td>
    		        <td>₹ ${student.term_1 || "0.00"}</td>
    		        <td>${student.joiningDate || "-"}</td>
    		      `;
    		      tbody.appendChild(term1Row);
    		      // Step 4: Add subsequent payments (from payments table)
    		      if (filtered.length === 0) {
    		        const noDataRow = document.createElement("tr");
    		        noDataRow.innerHTML = "<td colspan='4'>No transactions found.</td>";
    		        tbody.appendChild(noDataRow);
    		      } else {
    		        filtered.forEach((p) => {
    		          const row = document.createElement("tr");
    		          row.innerHTML = `
    		            <td>${p.term || "-"}</td>
    		            <td>${p.studentName || "-"}</td>
    		            <td>₹ ${p.amountPaid.toFixed(2)}</td>
    		            <td>${p.paymentDate || "-"}</td>
    		          `;
    		          tbody.appendChild(row);
    		        });
    		      }
    		      document.getElementById("termsModal").style.display = "block";
    		    })
    		    .catch((err) => {
    		      console.error("Error loading transaction details:", err);
    		    });
    		}
      //course type
      document.addEventListener("DOMContentLoaded", function () {
        fetchCourseTypes(); // Load on page load
      });
      function fetchCourseTypes() {
        fetch("http://localhost:8080/api/courses/names")
          .then((response) => response.json())
          .then((data) => {
            const courseDropdown = document.getElementById("CourseType");
            courseDropdown.innerHTML =
              "<option value=''>Select Course Type</option>";

            data.forEach((courseName) => {
              const option = document.createElement("option");
              option.value = courseName;
              option.textContent = courseName;
              courseDropdown.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error loading course types:", error);
          });
      }
      function loadStatuses() {
        const course = document.getElementById("CourseType").value;
        const statusDropdown = document.getElementById("BatchStatus");
        const batchCodeDropdown = document.getElementById("BatchCode");

        statusDropdown.innerHTML = "<option value=''>Loading...</option>";
        batchCodeDropdown.innerHTML = "<option value=''>Select Batch</option>";

        if (!course) {
          statusDropdown.innerHTML =
            "<option value=''>Select Course First</option>";
          return;
        }
        fetch(`http://localhost:8080/api/batch/statuses/${course}`)
          .then((response) => response.json())
          .then((data) => {
            statusDropdown.innerHTML =
              "<option value=''>Select Status</option>";
            data.forEach((status) => {
              const option = document.createElement("option");
              option.value = status;
              option.textContent = status;
              statusDropdown.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error loading statuses:", error);
            statusDropdown.innerHTML =
              "<option value=''>Failed to Load</option>";
          });
      }
      function loadBatchCodes() {
        const course = document.getElementById("CourseType").value;
        const status = document.getElementById("BatchStatus").value;
        const batchDropdown = document.getElementById("BatchCode");

        batchDropdown.innerHTML = "<option value=''>Loading...</option>";

        if (!course || !status) {
          batchDropdown.innerHTML =
            "<option value=''>Select Course & Status First</option>";
          return;
        }

        fetch(
          `http://localhost:8080/api/batch/codes?course=${course}&status=${status}`
        )
          .then((response) => response.json())
          .then((data) => {
            batchDropdown.innerHTML = "<option value=''>Select Batch</option>";
            data.forEach((code) => {
              const option = document.createElement("option");
              option.value = code;
              option.textContent = code;
              batchDropdown.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error loading batch codes:", error);
            batchDropdown.innerHTML =
              "<option value=''>Failed to Load</option>";
          });
      }
       window.onload = fetchDailyPayments;
    </script>
  </body>
</html>      
 